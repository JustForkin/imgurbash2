#!/bin/bash
# Copyright (c) 2016 Ramon <https://github.com/ram-on/imgurbash2>
# 
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
# 
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
# 
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.
#
#--------------------------------------------------------------------
# AUTHORS:  Ramon <https://github.com/ram-on/imgurbash2>
#           Originally written by Bart Nagel <bart@tremby.net>
# VERSION:  2.0
# REQUIRED: curl
# OPTIONAL: xsel or xclip for copying URLs to your clipboard.
#--------------------------------------------------------------------
#
# The URLs will be outputted on your terminal. If you have xsel or xclip the
# URLs will also be put on the X selection, which you can usually paste with a CTRL-V.


#
# Function to output usage instructions
#
# Parameters:  None
#
function usage {
	echo "Uploads images to imgur and output their imgurl URL link.  If xsel or xclip is" >&2
	echo "available, the links are copied to your clipboard." >&2
	echo "" >&2
	echo "Usage:" >&2
	echo "    $(basename $0) <image_1> [<image_2> [...]]" >&2
	echo "" >&2
	echo "Where:" >&2
	echo "    image_num   A local image file or a remote image (i.e. http/https)." >&2
}


#
# Returns true if the image is stored on a remote machine (i.e. http or https);
# false otherwise.
#
# Parameter:  URL to parse
#
function is_remote_image() {	
	if [ $(grep -i -E "^(http[s]?)://.+" <<< "$1")  ]; then
		return $(true)
	else
		return $(false)
	fi
}


#
# Uploads image to imgur
#
# Parameter:  Image file path or image URL
#
function upload_image() {
	clientid='1923eac1555838e'
	file="$1"

	# if the image is stored remotely...
	if is_remote_image "$file"; then
		curl -sH "Authorization: Client-ID $clientid" --data-urlencode "image=$file" "https://api.imgur.com/3/upload"
		
	# else if the local image file exists on disk...
	elif [ -f "$file" ]; then
		curl -sH "Authorization: Client-ID $clientid" -F "image=@$file" "https://api.imgur.com/3/upload"
	
	# else the file does not exist
	else
		echo '"error":"File does not exist, skipping"'
	fi
}


#
# Given a string it will try to extract its values (from the given JSON response).
# E.g.  '"error":"Invalid client_id"' ==> string = "error", value = "Invalid client_id"
#
# Paramateres:
#   $1 - Response JSON.
#   $2 - 'String' (not datatype) which will be used to get the value from.
#
function get_value_from_response() {
	sed -e 's/.*\"'$2'\":"\([^"]*\).*/\1/' <<< "$1"
}



# check arguments
if [ "$1" = "-h" -o "$1" = "--help" ]; then
	usage
	exit 0
elif [ $# == 0 ]; then
	echo "No file specified" >&2
	echo "" >&2
	usage
	exit 16
fi

# check curl is available
type curl >/dev/null 2>/dev/null || {
	echo "Couln't find curl, which is required." >&2
	exit 17
}

clip=""
errors=false

# loop through arguments
while [ $# -gt 0 ]; do
	file="$1"
	shift

	# upload the image
	response=$(upload_image "$file")
	
	# get image url link
	echo $response | grep -qo '"status":200' && url=$(get_value_from_response "$response" "link" | sed -e 's/\\//g')
	
	if [ -z "$url" ]; then
		errormsg=$(get_value_from_response "$response" "error")
		echo "Upload failed for $file:  $errormsg" >&2
		errors=true
		continue
	fi

	# output the URL
	printf '%s    (Delete Hash = %s)\n' "$url" $(get_value_from_response "$response" "deletehash")

	# append the URL to a string so we can put them all on the clipboard later
	clip="$clip$url
"
done

# put the URLs on the clipboard if we have xsel or xclip
if [ $DISPLAY ]; then
	{ type xsel >/dev/null 2>/dev/null && echo -n $clip | xsel --clipboard; } \
		|| { type xclip >/dev/null 2>/dev/null && echo -n $clip | xclip -sel "clip"; } \
		|| echo "Haven't copied to the clipboard: no xsel or xclip" >&2
else
	echo "Haven't copied to the clipboard: no \$DISPLAY" >&2
fi

if $errors; then
	exit 1
fi
